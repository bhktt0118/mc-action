name: ğŸ® Minecraft Server CI

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  deploy-mc-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # è®¾ç½®6å°æ—¶è¶…æ—¶
    env:
      WORLD_DATA_ARTIFACT_NAME: mc-world-data

    steps:
    - name: ğŸ—‚ï¸ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      run: |
        chmod +x scripts/*.py
        chmod +x scripts/*.sh 2>/dev/null || true

    - name: ğŸ’¾ ä¸‹è½½ä¹‹å‰ä¿å­˜çš„ä¸–ç•Œæ•°æ®
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.WORLD_DATA_ARTIFACT_NAME }}
        path: ./mc-data/
      continue-on-error: true # ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¼šå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„

    - name: ğŸ³ å®‰è£… Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose-plugin

    - name: ğŸ³ å¯åŠ¨ Minecraft æœåŠ¡å™¨æ ˆ
      run: |
        # è§£å‹å·²ä¸‹è½½çš„ä¸–ç•Œæ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        ls -la
        if [ -f "./mc-data/world-data-backup.tar.gz" ]; then
          echo "å‘ç°å·²å­˜åœ¨çš„ä¸–ç•Œæ•°æ®ï¼Œæ­£åœ¨è§£å‹..."
          tar -xzf ./mc-data/world-data-backup.tar.gz -C ./mc-data/ 2>/dev/null || true
        fi
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        mkdir -p mc-data
        docker-compose up -d
        
        # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
        echo "ç­‰å¾…MinecraftæœåŠ¡å™¨å¯åŠ¨..."
        sleep 60

    - name: â° å¯åŠ¨è‡ªåŠ¨å…³é—­å®ˆæŠ¤è„šæœ¬
      run: |
        # å®‰è£…Pythonä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
        python3 -c "import time; print('Pythonç¯å¢ƒæ­£å¸¸')" || echo "Pythonæ£€æŸ¥å®Œæˆ"
        
        # åœ¨åå°è¿è¡Œå®ˆæŠ¤è„šæœ¬
        nohup python3 scripts/auto-shutdown.py > shutdown.log 2>&1 &
        echo "å®ˆæŠ¤è„šæœ¬å·²å¯åŠ¨"

    - name: ğŸ•¹ï¸ ç­‰å¾…æœåŠ¡å™¨è¿è¡Œ
      run: |
        echo "ğŸš€ Minecraft æœåŠ¡å™¨å·²å¯åŠ¨ï¼"
        echo "â° å·¥ä½œæµå°†è¿è¡Œ6å°æ—¶ï¼Œ5å°æ—¶åè‡ªåŠ¨ä¿å­˜å…³é—­"
        echo "ğŸ’¡ æ‰‹åŠ¨åœæ­¢ï¼šåœ¨Actionsé¡µé¢ç‚¹å‡» 'Cancel workflow'"
        
        # ä¸»ç­‰å¾…å¾ªç¯ï¼ˆ5å°æ—¶ï¼‰
        sleep 18000
        
        echo "â³ å¼€å§‹è‡ªåŠ¨å…³é—­æµç¨‹..."

    - name: ğŸ›‘ å®‰å…¨åœæ­¢æœåŠ¡å™¨
      if: always()
      run: |
        echo "æ­£åœ¨åœæ­¢æœåŠ¡å™¨..."
        docker-compose down || true
        sleep 10

    - name: ğŸ’½ æ‰“åŒ…ä¸–ç•Œæ•°æ®
      if: always()
      run: |
        echo "æ­£åœ¨æ‰“åŒ…ä¸–ç•Œæ•°æ®..."
        mkdir -p backup-temp
        # å°è¯•å¤‡ä»½ä¸–ç•Œæ•°æ®
        if [ -d "./mc-data" ]; then
          tar -czf world-data-backup.tar.gz -C ./mc-data/ . 2>/dev/null || true
          ls -la *.tar.gz || echo "æœªæ‰¾åˆ°taræ–‡ä»¶ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
        else
          echo "mc-dataç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºå¤‡ä»½"
          touch world-data-backup.tar.gz
        fi

    - name: ğŸ“¤ ä¸Šä¼ ä¸–ç•Œæ•°æ®å·¥ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.WORLD_DATA_ARTIFACT_NAME }}
        path: world-data-backup.tar.gz
        retention-days: 90
      if: always()
