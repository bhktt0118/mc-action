name: ğŸ® Minecraft Server CI

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths-ignore: # å¿½ç•¥é…ç½®æ–‡ä»¶çš„æ›´æ”¹ï¼Œé¿å…æ— è°“è§¦å‘
      - 'README.md'

jobs:
  deploy-mc-server:
    runs-on: ubuntu-latest
    env:
      WORLD_DATA_ARTIFACT_NAME: mc-world-data

    steps:
    - name: ğŸ—‚ï¸ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ’¾ ä¸‹è½½ä¹‹å‰ä¿å­˜çš„ä¸–ç•Œæ•°æ®
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.WORLD_DATA_ARTIFACT_NAME }}
        path: ./mc-data/
      continue-on-error: true # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæ²¡æœ‰æ•°æ®æ˜¯æ­£å¸¸çš„

    - name: ğŸ³ å¯åŠ¨ Minecraft æœåŠ¡å™¨æ ˆ
      run: |
        docker-compose up -d
        # ç­‰å¾…æœåŠ¡å™¨åˆæ­¥å¯åŠ¨
        sleep 30

    - name: â° å¯åŠ¨è‡ªåŠ¨å…³é—­å®ˆæŠ¤è„šæœ¬
      run: |
        python3 scripts/auto-shutdown.py &

    - name: ğŸ•¹ï¸ ç­‰å¾…æœåŠ¡å™¨å·¥ä½œæµç»“æŸï¼ˆæ‰‹åŠ¨åœæ­¢ï¼‰
      run: |
        echo "ğŸš€ Minecraft æœåŠ¡å™¨å·²å¯åŠ¨ï¼å·¥ä½œæµå°†æœ€å¤šè¿è¡Œ6å°æ—¶ã€‚"
        echo "ğŸ’¡ å½“ä½ æƒ³æ‰‹åŠ¨åœæ­¢æœåŠ¡å™¨æ—¶ï¼Œè¯·åœ¨æ­¤ä»“åº“çš„ Actions é¡µé¢ç‚¹å‡» 'Cancel workflow'ã€‚"
        echo "â³ å®ˆæŠ¤è„šæœ¬å°†åœ¨5å°æ—¶åè‡ªåŠ¨ä¿å­˜å¹¶å…³é—­æœåŠ¡å™¨ã€‚"
        # ç”¨ä¸€ä¸ªé•¿ç¡çœ æ¥ä¿æŒ job æ´»è·ƒï¼Œç›´åˆ°è¢«æ‰‹åŠ¨å–æ¶ˆæˆ–è¶…æ—¶
        sleep 21600 # 6å°æ—¶ = 21600ç§’

    - name: ğŸ›‘ åœæ­¢ Docker å®¹å™¨
      if: always()
      run: |
        docker-compose down

    - name: ğŸ’½ ä¿å­˜ä¸–ç•Œæ•°æ®åˆ° Artifacts
      if: always()
      run: |
        echo "æ­£åœ¨æ‰“åŒ…ä¸–ç•Œæ•°æ®..."
        # å°†ä¸–ç•Œæ•°æ®æ‰“åŒ…ï¼Œä¾¿äºä¸Šä¼ 
        tar -czf world-data-backup.tar.gz -C ./mc-data/ .
      continue-on-error: true

    - name: ğŸ“¤ ä¸Šä¼ ä¸–ç•Œæ•°æ®å·¥ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.WORLD_DATA_ARTIFACT_NAME }}
        path: world-data-backup.tar.gz
        retention-days: 90
      if: always()
